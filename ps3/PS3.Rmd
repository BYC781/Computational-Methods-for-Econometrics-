---
title: "Untitled"
author: "Boyu Chen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(haven)
library(tidyverse)
setwd("/Users/bychen/Documents/ECON-7218/ps3")
```

## Read Data

```{r readdata}
# 建立一個空的list，用於存放所有的變數
data_list <- list()

# 使用循環來讀入檔案並儲存到list中
for (i in 1:76) {
  filename <- paste0("./problem_set_3_sample/group/group", i, ".dat")
  data <- read.table(filename)  # 使用適當的讀取函數，如read.table()
  data_list[[i]] <- data
}

# 將list中的變數名稱設定為"g1", "g2", ..., "g76"
names(data_list) <- paste0("g", 1:76)

# 可以透過data_list$g1, data_list$g2, ..., data_list$g76來存取相應的變數
```

```{r readnetwork}
# 建立一個空的list，用於存放所有的變數
network_lsit <- list()

# 使用循環來讀入檔案並儲存到list中
for (i in 1:76) {
  filename <- paste0("./problem_set_3_sample/network/network", i, ".dat")
  data <- read.table(filename)  # 使用適當的讀取函數，如read.table()
  network_lsit[[i]] <- data
}

# 將list中的變數名稱設定為"g1", "g2", ..., "g76"
names(network_lsit) <- paste0("W", 1:76)
```

```{r mergedata}
# 看起來沒有必要
combined_data <- bind_rows(data_list, .id = "group")
combined_data <- combined_data %>%
  mutate(group = as.integer(substring(group, 2)))
```

```{r setcolname}
col_names <- c('group','age', 'male', 'balck', 'asian', 'hisp', 'race.other', 
               'both.par', 'less.hs', 'more.hs', 'mom.edu.mis', 'welfare',
               'mom.job.miss', 'prof', 'job.other', 'sport', 'white', 
               'yr.school', 'gpa', 'overage')
colnames(combined_data) <- col_names
```
```{r set initparam}
init.lambda <- 1/10
init.a.g <- rnorm(76)
init.b <- c(rep(1, 17), rep(0.5, 17))
init.sigma2 <- 2
# init.param <- c(init.lambda, init.a.g, init.b, init.sigma2)
init.param <- c(rep(0, 111), 3)
```

```{r loglikelihood}
log_likeli <- function(param){
    lambda <- param[1]
    a.g <- param[2:77]
    b1 <- param[78:94]
    b2 <- param[95:111]
    sigma2 <- param[112]
    sigma2term <- - log(sigma2) * nrow(combined_data)/2 # OK
    logdetterm <-  sum(sapply(1:76, function(i) {
        logdetterm <- log(det(diag(nrow(network_lsit[[i]])) - lambda * as.matrix(network_lsit[[i]])))
        return(logdetterm)
    })) # OK
    inprodterm <- sum(sapply(1:76, function(i) {
        S.g <- diag(nrow(network_lsit[[i]])) - lambda * as.matrix(network_lsit[[i]])
        Y.g <- data_list[[i]][ ,18]
        X.g <- as.matrix(data_list[[i]][ , 1:17])
        W.g <- as.matrix(network_lsit[[i]])
        l.g <- rep(1, nrow(network_lsit[[i]]))
        e.g <- S.g %*% Y.g - X.g %*% b1 - W.g %*% X.g %*% b2 - a.g[i] * l.g
        e.gT_e.g <- t(e.g) %*% e.g
        return(e.gT_e.g)
    }))
    inprodterm <- -(2 * sigma2)^-1 * inprodterm

    likelihood <- sigma2term + logdetterm + inprodterm
    return(- likelihood)
}
```
```{r likelihood init.param}
log_likeli(init.param)
```
```{r runMLE}
result <-  optim(par = init.param, fn = log_likeli, method = "L-BFGS-B", lower = c(-0.1, rep(-Inf, 111)), upper = c(0.1, rep(Inf, 111)))
```

```{r test}
S.g <- diag(nrow(network_lsit[[i]])) - lambda * as.matrix(network_lsit[[i]])
Y.g <- data_list[[i]][ ,18]
X.g <- data_list[[i]][ ,2:17] %>% as.matrix()
W.g <- network_lsit[[i]] %>% as.matrix()
b1 <- rep(1, 16)
b2 <- rep(2,16)
l.g <- rep(1, nrow(network_lsit[[i]]))
a.g <- 5
e.g <- S.g %*% Y.g - X.g %*% b1 - W.g %*% X.g %*% b2 - a.g * l.g
e.gT_e.g <- t(e.g) %*% e.g
```

```{r test2}
inprodterm <- 0
lambda <- 0
b1 <- rep(1, 17)
b2 <- rep(2, 17)
sigma2 <- 2

for (i in 1:76){
    S.g <- diag(nrow(network_lsit[[i]])) - lambda * as.matrix(network_lsit[[i]])
    Y.g <- data_list[[i]][ ,18]
    X.g <- data_list[[i]][ ,1:17] %>% as.matrix()
    W.g <- network_lsit[[i]] %>% as.matrix()
    l.g <- rep(1, nrow(network_lsit[[i]]))
    a.g <- 5
    e.g <- S.g %*% Y.g - X.g %*% b1 - W.g %*% X.g %*% b2 - a.g * l.g
    e.gT_e.g <- t(e.g) %*% e.g
    
    inprodterm <- inprodterm + e.gT_e.g
}
inprodterm <- (2*sigma2)^-1 * inprodterm
```




